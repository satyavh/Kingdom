(function(){var e,t,n=[].slice,r=function(e,t){return function(){return e.apply(t,arguments)}};t=function(e,t,r){var i,s,o,u,a,f;arguments.length<3&&(a=[typeof exports!="undefined"?exports:window].concat(n.call(arguments)),e=a[0],t=a[1],r=a[2]),s=e,f=t.split(".");for(o=0,u=f.length;o<u;o++)i=f[o],e=e[i]||(e[i]={});return r(e,s)},e=function(){function e(e){this.name=e,this.castle=$('[data-bind="array: '+this.name+'"]'),this.stable=this.castle.find('[data-bind="template: '+this.name+'"]').detach()}return e.prototype.clear=function(){return this.castle.empty()},e.prototype.addStable=function(e){var t;return t=this.stable.clone().appendTo(this.castle).show(),t.attr("data-index",e),t.attr("data-model",this.name),t},e}(),this.Castle=function(){function n(e){this.toggleProperty=r(this.toggleProperty,this),this.get=r(this.get,this),this.set=r(this.set,this),this.destroy=r(this.destroy,this),this.append=r(this.append,this),this.detach=r(this.detach,this),this.render=r(this.render,this),this.applyBindings=r(this.applyBindings,this),this.applyBinding=r(this.applyBinding,this),this.renderStables=r(this.renderStables,this),this.evaluateIfs=r(this.evaluateIfs,this),this.evaluateUnlesses=r(this.evaluateUnlesses,this),this.evaluateUnless=r(this.evaluateUnless,this),this.evaluateIf=r(this.evaluateIf,this),this.findPropertyValue=r(this.findPropertyValue,this),this.uberCastle=r(this.uberCastle,this),this.hide=r(this.hide,this);var t,n,i,s,o;this.name=e.name;if(e.properties!=null){i=e.properties;for(t in i)n=i[t],this.processData(t,n)}if(e.functions!=null){s=e.functions;for(t in s)n=s[t],this[t]=n}if(e.soldiers!=null){o=e.soldiers;for(t in o)n=o[t],this.soldier(this.name+"."+t,n)}e.model!=null&&(this.model=model),this.castle=$("[data-template="+this.name+"]"),e.construct!=null&&(this.construct=e.construct,this.construct()),this.render()}var t;return n.prototype.stables=[],n.prototype.dom=[],n.prototype.bindings=["disabled","text","src","if","unless","array","href","id","value","height","width"],n.prototype.events=["click","hover","mouseover","mouseleave"],n.prototype.hide=function(){return this.castle.hide()},n.prototype.uberCastle=function(){return $(".template").hide(),this.castle.show()},n.prototype.findPropertyValue=function(e){var t,n,r,i;t=e.split("."),r=t[0];if(this[r]==null)return;return t.length>1?(n=t.slice(1).join("."),i=this[r][n]):i=this[r],i},n.prototype.evaluateIf=function(e){var t;return t=$('[data-bind="if: '+e+'"]'),this.findPropertyValue(e)===!0?(t.css({display:"inline"}),t.parent().find('> [data-bind="else"]').hide()):(t.hide(),t.parent().find('> [data-bind="else"]').css({display:"inline"}))},n.prototype.evaluateUnless=function(e){var t;return t=$('[data-bind="unless: '+e+'"]'),this.findPropertyValue(e)!==!0?(t.css({display:"inline"}),t.parent().find('> [data-bind="else"]').hide()):(t.hide(),t.parent().find('> [data-bind="else"]').css({display:"inline"}))},n.prototype.evaluateUnlesses=function(e){var t=this;return $('[data-bind*="unless: "]').each(function(n,r){var i,s;return s=$(r).data("bind").split(": "),i=s[0],e=s[1],t.evaluateUnless(e)})},n.prototype.evaluateIfs=function(e){var t=this;return $('[data-bind*="if: "]').each(function(n,r){var i,s;return s=$(r).data("bind").split(": "),i=s[0],e=s[1],t.evaluateIf(e)})},n.prototype.renderStables=function(t){var n,r,i,s,o,u,a,f;if(this[t]==null)return;s=_.filter(this.stables,function(e){return e.name===t}),s.length>0?(s=s[0],s.clear()):(s=new e(t),this.stables.push(s)),a=this.get(t),f=[];for(r=o=0,u=a.length;o<u;r=++o)i=a[r],n=s.addStable(r),f.push(this.applyBindings(n));return f},n.prototype.applyBinding=function(e,t,n){var r,i=this;n!=null&&(r=new RegExp("({{)([a-z.]*)(}})","ig"),r.test(n)?n=n.replace(r,function(t,n,r,s){return r=i._parseValue(e,r),r=i.findPropertyValue(r)}):n=this._parseValue(e,n));if(_.indexOf(this.bindings,t)>-1)switch(t){case"disabled":$(e).is("input","button")?$(e).prop(t,this.findPropertyValue(n)):$(e).attr(t,this.findPropertyValue(n));break;case"text":$(e).text(this.findPropertyValue(n));break;case"src":case"id":this.findPropertyValue(n)!=null?$(e).attr(t,this.findPropertyValue(n)):$(e).attr(t,n);break;case"if":this.evaluateIf(n);break;case"unless":this.evaluateUnless(n);break;case"value":$(e).val(this.findPropertyValue(n)),$(e).keyup(function(e){return console.log(e.target.value),i.set(i[n],e.target.value)});break;case"array":this.renderStables(n);break;case"background-image":$(e).css({"background-image":'url("'+this.findPropertyValue(n)+'")'});break;case"height":case"width":$(e).css({binding:this.findPropertyValue(n)})}_.indexOf(this.events,t)>-1&&$(e).on(t,function(t){return t.preventDefault(),t.stopPropagation(),i[n](e)});if(_.indexOf(this.bindings,t)===-1&&_.indexOf(this.events,t)===-1&&n!=null)return $(e).attr("data-"+t,this.findPropertyValue(n))},n.prototype._parseValue=function(e,t){var n,r,i,s;return t!=null&&(s=t.split("."),s[0]==="model"&&(i=$(e).closest(".template"),r=i.data("model"),n=i.data("index"),console.log(r,n),t=r+"."+n+"."+s[1])),t},n.prototype.applyBindings=function(e){var t=this;return $(e).find("[data-bind]").each(function(e,n){var r,i,s,o,u,a,f,l;s=$(n).data("bind").replace(/\s/g,"").split(","),l=[];for(u=0,a=s.length;u<a;u++)i=s[u],f=i.split(":"),r=f[0],o=f[1],t.addToDom(n,r,o),l.push(t.applyBinding(n,r,o));return l})},n.prototype.addToDom=function(e,t,n){return this.dom.push({el:e,binding:t,value:n})},n.prototype.render=function(){var e=this;return $(document).ready(function(){return e.castle.show(),e.applyBindings(e.castle)})},n.prototype.detach=function(){return this.castle=this.castle.detach()},n.prototype.append=function(e){return e.append(this.castle)},n.prototype.destroy=function(){return this.castle.empty(),delete this},n.prototype.set=function(e,t){var n,r,i,s,o;this.processData(e,t),this.order(e,t);if(!this.dom)return;r=_.filter(this.dom,function(t){return t.value===e});if(r.length>0){o=[];for(i=0,s=r.length;i<s;i++)n=r[i],o.push(this.applyBinding(n.el,n.binding,n.value));return o}return},n.prototype.get=function(e){return _.isObject(this[e])?Kingdom.unflatten(this[e]):this[e]},t=$({}),n.prototype.toggleProperty=function(e){var t;t=this.get(e);if(typeof t!="boolean")return;return this.set(e,!t)},n.prototype.orders={},n.prototype.soldier=function(e,t){return this.orders[e]||(this.orders[e]=[]),this.orders[e].push(t)},n.prototype.order=function(e,t,n){var r=this;n==null&&(n=!0),n&&(e=this.name+"."+e);if(!this.orders[e]||this.orders[e].length<1)return;return _.each(this.orders[e],function(e){e.apply(r,[t]||[])})},n.prototype.dischargeSoldier=function(e){return this.orders[e]},n.prototype.processData=function(e,t){return _.isObject(t)?t.length===0?this[e]=[]:this[e]=Kingdom.flatten(t):this[e]=t},n.prototype.renderMustaches=function(e){var t;return e=$(e),t=new RegExp("({{)([a-z .]*)(}})","g"),e},n}(),this.Kingdom={create:function(n){return t(n,function(t){return t.Castle=Castle,t.Stable=e})},flatten:function(e){var t,n;return n={},t=function(e,r){var i,s,o,u;if(Object(e)!==e)n[r]=e;else if(_.isArray(e)){i=0,o=e.length;while(i<o)t(e[i],r?r+"."+i:""+i),i++;o===0&&(n[r]=[])}else{s=!0;for(u in e)s=!1,t(e[u],r?r+"."+u:u);s&&(n[r]={})}},t(e,""),n},unflatten:function(e){"use strict";var t,n,r,i,s,o,u;if(Object(e)!==e||_.isArray(e))return e;o={},t=void 0,s=void 0,n=void 0,r=void 0,u=void 0;for(i in e){t=o,s="",r=0;for(;;){n=i.indexOf(".",r),u=i.substring(r,n!==-1?n:void 0),t=t[s]||(t[s]=isNaN(parseInt(u))?{}:[]),s=u,r=n+1;if(!(n>=0))break}t[s]=e[i]}return o[""]}}}).call(this)