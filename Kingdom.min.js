(function(){var t,e,i=[].slice,n=function(t,e){return function(){return t.apply(e,arguments)}};e=function(t,e,n){var s,r,a,o,l,h;for(arguments.length<3&&(l=["undefined"!=typeof exports?exports:window].concat(i.call(arguments)),t=l[0],e=l[1],n=l[2]),r=t,h=e.split("."),a=0,o=h.length;o>a;a++)s=h[a],t=t[s]||(t[s]={});return n(t,r)},t=function(){function t(t){this.name=t,this.castle=$('[data-bind="array: '+this.name+'"]'),this.stable=this.castle.find('[data-bind="template: '+this.name+'"]').detach()}return t.prototype.clear=function(){return this.castle.empty()},t.prototype.addStable=function(t){var e;return e=this.stable.clone().appendTo(this.castle).show(),e.attr("data-index",t),e.attr("data-model",this.name),e},t}(),this.Castle=function(){function e(t){this.toggleProperty=n(this.toggleProperty,this),this.get=n(this.get,this),this.set=n(this.set,this),this.destroy=n(this.destroy,this),this.append=n(this.append,this),this.detach=n(this.detach,this),this.render=n(this.render,this),this.applyBindings=n(this.applyBindings,this),this.applyBinding=n(this.applyBinding,this),this.renderStables=n(this.renderStables,this),this.evaluateIfs=n(this.evaluateIfs,this),this.evaluateUnlesses=n(this.evaluateUnlesses,this),this.evaluateUnless=n(this.evaluateUnless,this),this.evaluateIf=n(this.evaluateIf,this),this.findPropertyValue=n(this.findPropertyValue,this),this.uberCastle=n(this.uberCastle,this),this.hide=n(this.hide,this);var e,i,s,r,a;if(this.name=t.name,null!=t.properties){s=t.properties;for(e in s)i=s[e],this.processData(e,i)}if(null!=t.functions){r=t.functions;for(e in r)i=r[e],this[e]=i}if(null!=t.soldiers){a=t.soldiers;for(e in a)i=a[e],this.soldier(this.name+"."+e,i)}null!=t.model&&(this.model=model),this.castle=$("[data-template="+this.name+"]"),null!=t.construct&&(this.construct=t.construct,this.construct()),this.render()}var i;return e.prototype.stables=[],e.prototype.dom=[],e.prototype.bindings=["disabled","text","src","if","unless","array","href","id","value","height","width"],e.prototype.events=["click","hover","mouseover","mouseleave"],e.prototype.hide=function(){return this.castle.hide()},e.prototype.uberCastle=function(){return $(".template").hide(),this.castle.show()},e.prototype.findPropertyValue=function(t){var e,i,n,s;return e=t.split("."),n=e[0],null!=this[n]?(e.length>1?(i=e.slice(1).join("."),s=this[n][i]):s=this[n],s):void 0},e.prototype.evaluateIf=function(t){var e;return e=$('[data-bind="if: '+t+'"]'),this.findPropertyValue(t)===!0?(e.css({display:"inline"}),e.parent().find('> [data-bind="else"]').hide()):(e.hide(),e.parent().find('> [data-bind="else"]').css({display:"inline"}))},e.prototype.evaluateUnless=function(t){var e;return e=$('[data-bind="unless: '+t+'"]'),this.findPropertyValue(t)!==!0?(e.css({display:"inline"}),e.parent().find('> [data-bind="else"]').hide()):(e.hide(),e.parent().find('> [data-bind="else"]').css({display:"inline"}))},e.prototype.evaluateUnlesses=function(t){var e=this;return $('[data-bind*="unless: "]').each(function(i,n){var s,r;return r=$(n).data("bind").split(": "),s=r[0],t=r[1],e.evaluateUnless(t)})},e.prototype.evaluateIfs=function(t){var e=this;return $('[data-bind*="if: "]').each(function(i,n){var s,r;return r=$(n).data("bind").split(": "),s=r[0],t=r[1],e.evaluateIf(t)})},e.prototype.renderStables=function(e){var i,n,s,r,a,o,l,h;if(null!=this[e]){for(r=_.filter(this.stables,function(t){return t.name===e}),r.length>0?(r=r[0],r.clear()):(r=new t(e),this.stables.push(r)),l=this.get(e),h=[],n=a=0,o=l.length;o>a;n=++a)s=l[n],i=r.addStable(n),h.push(this.applyBindings(i));return h}},e.prototype.applyBinding=function(t,e,i){var n,s=this;if(null!=i&&(n=new RegExp("({{)([a-z.]*)(}})","ig"),i=n.test(i)?i.replace(n,function(e,i,n,r){return n=s._parseValue(t,n),n=s.findPropertyValue(n)}):this._parseValue(t,i)),_.indexOf(this.bindings,e)>-1)switch(e){case"disabled":$(t).is("input","button")?$(t).prop(e,this.findPropertyValue(i)):$(t).attr(e,this.findPropertyValue(i));break;case"text":$(t).text(this.findPropertyValue(i));break;case"src":case"id":null!=this.findPropertyValue(i)?$(t).attr(e,this.findPropertyValue(i)):$(t).attr(e,i);break;case"if":this.evaluateIf(i);break;case"unless":this.evaluateUnless(i);break;case"value":$(t).val(this.findPropertyValue(i)),$(t).keyup(function(t){return console.log(t.target.value),s.set(s[i],t.target.value)});break;case"array":this.renderStables(i);break;case"background-image":$(t).css({"background-image":'url("'+this.findPropertyValue(i)+'")'});break;case"height":case"width":$(t).css({binding:this.findPropertyValue(i)})}return _.indexOf(this.events,e)>-1&&$(t).on(e,function(e){return e.preventDefault(),e.stopPropagation(),s[i](t)}),-1===_.indexOf(this.bindings,e)&&-1===_.indexOf(this.events,e)&&null!=i?$(t).attr("data-"+e,this.findPropertyValue(i)):void 0},e.prototype._parseValue=function(t,e){var i,n,s,r;return null!=e&&(r=e.split("."),"model"===r[0]&&(s=$(t).closest(".template"),n=s.data("model"),i=s.data("index"),console.log(n,i),e=n+"."+i+"."+r[1])),e},e.prototype.applyBindings=function(t){var e=this;return $(t).find("[data-bind]").each(function(t,i){var n,s,r,a,o,l,h,u;for(r=$(i).data("bind").replace(/\s/g,"").split(","),u=[],o=0,l=r.length;l>o;o++)s=r[o],h=s.split(":"),n=h[0],a=h[1],e.addToDom(i,n,a),u.push(e.applyBinding(i,n,a));return u})},e.prototype.addToDom=function(t,e,i){return this.dom.push({el:t,binding:e,value:i})},e.prototype.render=function(){var t=this;return $(document).ready(function(){return t.castle.show(),t.applyBindings(t.castle)})},e.prototype.detach=function(){return this.castle=this.castle.detach()},e.prototype.append=function(t){return t.append(this.castle)},e.prototype.destroy=function(){return this.castle.empty(),delete this},e.prototype.set=function(t,e){var i,n,s,r,a;if(this.processData(t,e),this.order(t,e),this.dom&&(n=_.filter(this.dom,function(e){return e.value===t}),n.length>0)){for(a=[],s=0,r=n.length;r>s;s++)i=n[s],a.push(this.applyBinding(i.el,i.binding,i.value));return a}},e.prototype.get=function(t){return _.isObject(this[t])?Kingdom.unflatten(this[t]):this[t]},i=$({}),e.prototype.toggleProperty=function(t){var e;return e=this.get(t),"boolean"==typeof e?this.set(t,!e):void 0},e.prototype.orders={},e.prototype.soldier=function(t,e){return this.orders[t]||(this.orders[t]=[]),this.orders[t].push(e)},e.prototype.order=function(t,e,i){var n=this;return null==i&&(i=!0),i&&(t=this.name+"."+t),!this.orders[t]||this.orders[t].length<1?void 0:_.each(this.orders[t],function(t){t.apply(n,[e]||[])})},e.prototype.dischargeSoldier=function(t){return this.orders[t]},e.prototype.processData=function(t,e){return _.isObject(e)?0===e.length?this[t]=[]:this[t]=Kingdom.flatten(e):this[t]=e},e.prototype.renderMustaches=function(t){var e;return t=$(t),e=new RegExp("({{)([a-z .]*)(}})","g"),t},e}(),this.Kingdom={create:function(i){return e(i,function(e){return e.Castle=Castle,e.Stable=t})},flatten:function(t){var e,i;return i={},e=function(t,n){var s,r,a,o;if(Object(t)!==t)i[n]=t;else if(_.isArray(t)){for(s=0,a=t.length;a>s;)e(t[s],n?n+"."+s:""+s),s++;0===a&&(i[n]=[])}else{r=!0;for(o in t)r=!1,e(t[o],n?n+"."+o:o);r&&(i[n]={})}},e(t,""),i},unflatten:function(t){"use strict";var e,i,n,s,r,a,o;if(Object(t)!==t||_.isArray(t))return t;a={},e=void 0,r=void 0,i=void 0,n=void 0,o=void 0;for(s in t){for(e=a,r="",n=0;i=s.indexOf(".",n),o=s.substring(n,-1!==i?i:void 0),e=e[r]||(e[r]=isNaN(parseInt(o))?{}:[]),r=o,n=i+1,i>=0;);e[r]=t[s]}return a[""]}}}).call(this);